<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Handoff Viewer</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
  <style>
    body { margin: 0; background: #1e1e1e; height: 100vh; display: flex; flex-direction: column; align-items: center; }
    #controls { padding: 10px; }
    #controls button, #controls input { margin: 0 5px; padding: 8px 16px; font-size: 14px; }
    #terminal { width: 90%; flex: 1; }
  </style>
</head>
<body>
  <div id="controls">
    <button onclick="send('y\r')">y</button>
    <button onclick="send('n\r')">n</button>
    <button onclick="send('t\r')">t</button>
    <button onclick="send('\x03')">Ctrl-C</button>
    <button onclick="send('\x1b')">Esc</button>
    <button onclick="send('\x1b[A')">↑</button>
    <button onclick="send('\x1b[B')">↓</button>
    <button onclick="send('\x1b[D')">←</button>
    <button onclick="send('\x1b[C')">→</button>
    <button onclick="send('\x7f')">⌫</button>
    <input type="text" id="custom" placeholder="custom input" onkeydown="if(event.key==='Enter'){sendLine(this.value);this.value='';}">
    <button onclick="sendLine(document.getElementById('custom').value); document.getElementById('custom').value='';">Send</button>
  </div>
  <div id="terminal"></div>
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const sessionId = params.get('id');
    const token = params.get('token');
    
    if (!sessionId || !token) {
      document.body.innerHTML = '<div style="color:#fff;padding:20px;"><h2>Connect to Session</h2><form onsubmit="location.search=\'?id=\'+id.value+\'&token=\'+tok.value;return false;"><input id="id" placeholder="Session ID" style="padding:8px;margin:5px;"><input id="tok" placeholder="Token" style="padding:8px;margin:5px;"><button style="padding:8px 16px;">Connect</button></form></div>';
    } else {
      const term = new Terminal();
      const fitAddon = new FitAddon.FitAddon();
      term.loadAddon(fitAddon);
      term.open(document.getElementById('terminal'));
      fitAddon.fit();
      window.addEventListener('resize', () => fitAddon.fit());
      const ws = new WebSocket('ws://' + location.host + '/ws?id=' + sessionId + '&token=' + token);
      ws.onopen = () => console.log('ws connected');
      ws.onmessage = async (e) => {
        console.log('ws message:', e.data);
        if (typeof e.data === 'string') {
          try {
            const msg = JSON.parse(e.data);
            if (msg.type === 'exit') term.write('\r\n[Process exited with code ' + msg.code + ']');
          } catch { term.write(e.data); }
        } else if (e.data instanceof Blob) {
          term.write(new Uint8Array(await e.data.arrayBuffer()));
        } else {
          term.write(new Uint8Array(e.data));
        }
      };
      ws.onclose = (e) => { console.log('ws closed', e.code, e.reason); term.write('\r\n[Connection closed: ' + (e.reason || e.code) + ']'); };
      term.onData((data) => { if (ws.readyState === 1) ws.send(data); });
      window.send = (text) => { if (ws.readyState === 1) ws.send(text); };
      window.sendLine = (text) => { if (ws.readyState === 1) ws.send(text + '\r'); };
    }
  </script>
</body>
</html>
